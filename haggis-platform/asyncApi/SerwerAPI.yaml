asyncapi: 2.6.0
info:
  title: Serwer Async API
  version: 1.0.0
  description: Kontrakt asynchroniczny dla pokoi gry (gameroom) i czatu przez WebSocket.
defaultContentType: application/json

servers:
  local:
    url: localhost:5167
    protocol: ws
    description: Lokalny serwer WebSocket

channels:
  session/login:
    description: Logowanie gracza i utworzenie sesji online.
    publish:
      operationId: sessionLogin
      summary: Klient wysyla dane logowania sesji.
      message:
        $ref: '#/components/messages/SessionLoginRequestMessage'
    subscribe:
      operationId: sessionAuthenticated
      summary: Serwer potwierdza sesje albo zwraca blad.
      message:
        oneOf:
          - $ref: '#/components/messages/SessionLoginResponseMessage'
          - $ref: '#/components/messages/ErrorMessage'

  rooms/create:
    description: Tworzenie pokoju gry.
    publish:
      operationId: createGameRoom
      summary: Klient wysyla polecenie utworzenia pokoju.
      message:
        $ref: '#/components/messages/CreateGameRoomRequestMessage'
    subscribe:
      operationId: roomCreated
      summary: Serwer zwraca utworzony pokoj albo blad.
      message:
        oneOf:
          - $ref: '#/components/messages/GameRoomResponseMessage'
          - $ref: '#/components/messages/ErrorMessage'

  rooms/list:
    description: Pobranie listy pokoi gry.
    publish:
      operationId: listGameRooms
      summary: Klient prosi o liste pokoi.
      message:
        $ref: '#/components/messages/ListGameRoomsRequestMessage'
    subscribe:
      operationId: gameRoomsList
      summary: Serwer zwraca liste pokoi albo blad.
      message:
        oneOf:
          - $ref: '#/components/messages/GameRoomListMessage'
          - $ref: '#/components/messages/ErrorMessage'

  rooms/{roomId}/join:
    description: Dolaczanie gracza do istniejacego pokoju.
    parameters:
      roomId:
        description: Id pokoju gry.
        schema:
          type: string
          minLength: 1
    publish:
      operationId: joinGameRoom
      summary: Klient wysyla polecenie dolaczenia do pokoju.
      message:
        $ref: '#/components/messages/JoinGameRoomRequestMessage'
    subscribe:
      operationId: roomJoined
      summary: Serwer zwraca zaktualizowany pokoj albo blad.
      message:
        oneOf:
          - $ref: '#/components/messages/GameRoomResponseMessage'
          - $ref: '#/components/messages/ErrorMessage'

  chat/global:
    description: Globalny czat niezalezny od konkretnej gry.
    publish:
      operationId: sendChatMessage
      summary: Klient wysyla wiadomosc czatu.
      message:
        $ref: '#/components/messages/SendChatMessageRequestMessage'
    subscribe:
      operationId: chatStream
      summary: Serwer emituje wiadomosci czatu albo blad.
      message:
        oneOf:
          - $ref: '#/components/messages/ChatMessage'
          - $ref: '#/components/messages/ErrorMessage'

  chat/rooms/{roomId}:
    description: Czat pokojowy dla konkretnego roomId (przed, w trakcie i po grze).
    parameters:
      roomId:
        description: Id pokoju gry.
        schema:
          type: string
          minLength: 1
    publish:
      operationId: sendRoomChatMessage
      summary: Klient wysyla wiadomosc czatu pokojowego.
      message:
        $ref: '#/components/messages/SendRoomChatMessageRequestMessage'
    subscribe:
      operationId: roomChatStream
      summary: Serwer emituje wiadomosci czatu pokojowego albo blad.
      message:
        oneOf:
          - $ref: '#/components/messages/RoomChatMessage'
          - $ref: '#/components/messages/ErrorMessage'

components:
  messages:
    SessionLoginRequestMessage:
      name: SessionLoginRequestMessage
      title: Session login command
      payload:
        $ref: '#/components/schemas/SessionLoginRequest'

    SessionLoginResponseMessage:
      name: SessionLoginResponseMessage
      title: Session authenticated event
      payload:
        $ref: '#/components/schemas/SessionLoginResponse'

    CreateGameRoomRequestMessage:
      name: CreateGameRoomRequestMessage
      title: Create game room command
      payload:
        $ref: '#/components/schemas/CreateGameRoomRequest'

    ListGameRoomsRequestMessage:
      name: ListGameRoomsRequestMessage
      title: List game rooms command
      payload:
        $ref: '#/components/schemas/ListGameRoomsRequest'

    JoinGameRoomRequestMessage:
      name: JoinGameRoomRequestMessage
      title: Join game room command
      payload:
        $ref: '#/components/schemas/JoinGameRoomRequest'

    GameRoomResponseMessage:
      name: GameRoomResponseMessage
      title: Game room event
      payload:
        $ref: '#/components/schemas/GameRoomResponse'

    GameRoomListMessage:
      name: GameRoomListMessage
      title: Game room list event
      payload:
        $ref: '#/components/schemas/GameRoomList'

    SendChatMessageRequestMessage:
      name: SendChatMessageRequestMessage
      title: Send chat message command
      payload:
        $ref: '#/components/schemas/SendChatMessageRequest'

    ChatMessage:
      name: ChatMessage
      title: Chat message event
      payload:
        $ref: '#/components/schemas/ChatMessage'

    SendRoomChatMessageRequestMessage:
      name: SendRoomChatMessageRequestMessage
      title: Send room chat message command
      payload:
        $ref: '#/components/schemas/SendRoomChatMessageRequest'

    RoomChatMessage:
      name: RoomChatMessage
      title: Room chat message event
      payload:
        $ref: '#/components/schemas/RoomChatMessage'

    ErrorMessage:
      name: ErrorMessage
      title: Error event
      payload:
        $ref: '#/components/schemas/ProblemDetails'

  schemas:
    SessionLoginRequest:
      type: object
      required: [playerId]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1

    SessionLoginResponse:
      type: object
      required: [sessionId, playerId, connectedAt, status]
      additionalProperties: false
      properties:
        sessionId:
          type: string
        playerId:
          type: string
        connectedAt:
          type: string
          format: date-time
        status:
          type: string
          enum: [authenticated]

    CreateGameRoomRequest:
      type: object
      required: [gameType, hostPlayerId]
      additionalProperties: false
      properties:
        gameType:
          type: string
          enum: [haggis]
        hostPlayerId:
          type: string
          minLength: 1
        roomName:
          type: string
          minLength: 1

    ListGameRoomsRequest:
      type: object
      additionalProperties: false
      properties: {}

    JoinGameRoomRequest:
      type: object
      required: [playerId]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1

    GameRoomResponse:
      type: object
      required: [roomId, gameId, gameType, roomName, createdAt, players, gameEndpoint]
      additionalProperties: false
      properties:
        roomId:
          type: string
        gameId:
          type: string
        gameType:
          type: string
          enum: [haggis]
        roomName:
          type: string
        createdAt:
          type: string
          format: date-time
        players:
          type: array
          items:
            type: string
        gameEndpoint:
          type: string
          description: Link do endpointu gry specyficznego dla gameType.
          example: /games/8b8a8de7ac5e4fa88b610f44d6872f3d/actions

    GameRoomList:
      type: array
      items:
        $ref: '#/components/schemas/GameRoomResponse'

    SendChatMessageRequest:
      type: object
      required: [playerId, text]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        text:
          type: string
          minLength: 1
          maxLength: 500

    ChatMessage:
      type: object
      required: [messageId, playerId, text, createdAt]
      additionalProperties: false
      properties:
        messageId:
          type: string
        playerId:
          type: string
        text:
          type: string
        createdAt:
          type: string
          format: date-time

    SendRoomChatMessageRequest:
      type: object
      required: [playerId, text]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        text:
          type: string
          minLength: 1
          maxLength: 500

    RoomChatMessage:
      type: object
      required: [messageId, roomId, playerId, text, createdAt]
      additionalProperties: false
      properties:
        messageId:
          type: string
        roomId:
          type: string
        playerId:
          type: string
        text:
          type: string
        createdAt:
          type: string
          format: date-time

    ProblemDetails:
      type: object
      required: [title, status]
      properties:
        type:
          type: string
        title:
          type: string
        status:
          type: integer
          format: int32
        detail:
          type: string
        instance:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
