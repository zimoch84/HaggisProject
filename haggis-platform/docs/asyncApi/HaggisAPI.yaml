asyncapi: 2.6.0
info:
  title: Haggis Infrastructure Async API
  version: 3.0.0
  description: Realtime API based on operation envelopes.
defaultContentType: application/json

servers:
  ws:
    url: localhost:8080
    protocol: ws
    description: WebSocket endpoints

channels:
  ws/global/chat:
    description: Global chat channel. On connect server returns room list and recent global chat history.
    publish:
      operationId: sendGlobalOperation
      message:
        oneOf:
          - $ref: "#/components/messages/GlobalChatOperationMessage"
          - $ref: "#/components/messages/GlobalListRoomOperationMessage"
          - $ref: "#/components/messages/GlobalCreateRoomOperationMessage"
          - $ref: "#/components/messages/GlobalPrivateChatOperationMessage"
    subscribe:
      operationId: receiveGlobalOperation
      message:
        $ref: "#/components/messages/GlobalOperationEnvelopeMessage"

  ws/games/{gameId}:
    description: Game channel with operation-based commands.
    parameters:
      gameId:
        schema:
          type: string
          minLength: 1
    publish:
      operationId: sendGameOperation
      message:
        oneOf:
          - $ref: "#/components/messages/GameJoinOperationMessage"
          - $ref: "#/components/messages/GameCreateOperationMessage"
          - $ref: "#/components/messages/GameChatOperationMessage"
          - $ref: "#/components/messages/GameCommandOperationMessage"
    subscribe:
      operationId: receiveGameOperation
      message:
        $ref: "#/components/messages/GameOperationEnvelopeMessage"

components:
  messages:
    GlobalChatOperationMessage:
      payload:
        $ref: "#/components/schemas/GlobalChatOperation"
    GlobalListRoomOperationMessage:
      payload:
        $ref: "#/components/schemas/GlobalListRoomOperation"
    GlobalCreateRoomOperationMessage:
      payload:
        $ref: "#/components/schemas/GlobalCreateRoomOperation"
    GlobalPrivateChatOperationMessage:
      payload:
        $ref: "#/components/schemas/GlobalPrivateChatOperation"
    GlobalOperationEnvelopeMessage:
      payload:
        $ref: "#/components/schemas/GlobalOperationEnvelope"

    GameJoinOperationMessage:
      payload:
        $ref: "#/components/schemas/GameJoinOperation"
    GameCreateOperationMessage:
      payload:
        $ref: "#/components/schemas/GameCreateOperation"
    GameChatOperationMessage:
      payload:
        $ref: "#/components/schemas/GameChatOperation"
    GameCommandOperationMessage:
      payload:
        $ref: "#/components/schemas/GameCommandOperation"
    GameOperationEnvelopeMessage:
      payload:
        $ref: "#/components/schemas/GameOperationEnvelope"

  schemas:
    GlobalOperationEnvelope:
      type: object
      required: [operation, data]
      additionalProperties: true
      properties:
        operation:
          type: string
          enum: [bootstrap, chat, listroom, createroom, privatechat, unknown]
        data:
          type: object
          additionalProperties: true

    GlobalChatOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [chat]
        payload:
          $ref: "#/components/schemas/SendChatMessageRequest"

    GlobalListRoomOperation:
      type: object
      required: [operation]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [listroom]
        payload:
          type: object
          nullable: true
          additionalProperties: true

    GlobalCreateRoomOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [createroom]
        payload:
          $ref: "#/components/schemas/CreateRoomRequest"

    GlobalPrivateChatOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [privatechat]
        payload:
          $ref: "#/components/schemas/PrivateChatRequest"

    GameOperationEnvelope:
      type: object
      required: [operation, data]
      additionalProperties: true
      properties:
        operation:
          type: string
          enum: [join, create, chat, command, unknown]
        data:
          type: object
          additionalProperties: true

    GameJoinOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [join]
        payload:
          $ref: "#/components/schemas/JoinPayload"

    GameCreateOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [create]
        payload:
          $ref: "#/components/schemas/CreatePayload"

    GameChatOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [chat]
        payload:
          $ref: "#/components/schemas/GameChatMessage"

    GameCommandOperation:
      type: object
      required: [operation, payload]
      additionalProperties: false
      properties:
        operation:
          type: string
          enum: [command]
        payload:
          $ref: "#/components/schemas/CommandPayload"

    SendChatMessageRequest:
      type: object
      required: [playerId, text]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        text:
          type: string
          minLength: 1

    CreateRoomRequest:
      type: object
      required: [playerId]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        gameType:
          type: string
        roomName:
          type: string
        roomId:
          type: string

    PrivateChatRequest:
      type: object
      required: [playerId, targetPlayerId]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        targetPlayerId:
          type: string
          minLength: 1
        roomName:
          type: string
        roomId:
          type: string

    JoinPayload:
      type: object
      required: [playerId]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1

    CreatePayload:
      type: object
      required: [playerId]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        payload:
          type: object
          additionalProperties: true

    CommandPayload:
      type: object
      required: [command]
      additionalProperties: false
      properties:
        command:
          $ref: "#/components/schemas/GameCommand"
        state:
          $ref: "#/components/schemas/GameStateSnapshot"

    GameRoomResponse:
      type: object
      required: [roomId, gameId, gameType, roomName, createdAt, players, gameEndpoint]
      additionalProperties: false
      properties:
        roomId:
          type: string
        gameId:
          type: string
        gameType:
          type: string
        roomName:
          type: string
        createdAt:
          type: string
          format: date-time
        players:
          type: array
          items:
            type: string
        gameEndpoint:
          type: string
          description: Realtime game endpoint path (`/ws/games/{gameId}`).

    GameCommand:
      type: object
      required: [type, playerId, payload]
      additionalProperties: false
      properties:
        type:
          type: string
        playerId:
          type: string
          minLength: 1
        payload:
          type: object
          additionalProperties: true

    GameChatMessage:
      type: object
      required: [playerId, text]
      additionalProperties: false
      properties:
        playerId:
          type: string
          minLength: 1
        text:
          type: string
          minLength: 1

    GameStateSnapshot:
      type: object
      required: [version, data, updatedAt]
      additionalProperties: false
      properties:
        version:
          type: integer
          format: int64
        data:
          type: object
          additionalProperties: true
        updatedAt:
          type: string
          format: date-time
